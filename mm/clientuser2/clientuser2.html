<!DOCTYPE html>
<html>
<head>
    <title>用户管理</title>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <script src="../../libs/jquery.min.js"></script>
    <script src="../../libs/jquery.cookie.js"></script>
    <script src="../../libs/giveup2.js"></script>
    <script src="../../libs/jquery.growl/javascripts/jquery.growl.js" type="text/javascript"></script>
    <link href="../../libs/jquery.growl/stylesheets/jquery.growl.css" rel="stylesheet" type="text/css" />

    <style>
        .cell {
            text-align: center;
            display: inline-block;
            padding:0 5px;
            overflow: hidden;
            height:100%;
            white-space:nowrap;
            text-overflow:ellipsis;
            cursor: default;
        }
        .cell1 {
            width:60px;
        }
        .cell2 {
            width:200px;
            border-left: 1px solid #7d7d7d;
        }
        .cell3 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell4 {
            width:50px;
            border-left: 1px solid #7d7d7d;
        }
        .cell5 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell6 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell7 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell8 {
            width:50px;
            border-left: 1px solid #7d7d7d;
        }
        .cell9 {
            width:150px;
            border-left: 1px solid #7d7d7d;
        }
        .cell10 {
            width:150px;
            border-left: 1px solid #7d7d7d;
        }
        .cell11 {
            width:150px;
            border-left: 1px solid #7d7d7d;
        }
        .row {
            border-top: 1px solid #7d7d7d;
            padding:3px 0;
            height:20px;
            font-size:15px;
        }

        .row-item:hover{
            background-color:#e8e8e8;
        }

        .row-title {
            background-color:#e8e8e8;
        }


    </style>
</head>

<body style="margin:0;">
<div id="currentPath"  style="margin:5px 0 0 5px;font-size: 14px"></div>
<hr/>
<div style="width:100%;margin-top:5px;">
    <button style="margin:0 5px;display:inline-block;margin-top:5px;min-width:60px;padding:0 10px;height:25px" onclick="query()">查询</button>
    <button style="margin:0 5px;display:inline-block;margin-top:5px;min-width:60px;padding:0 10px;height:25px" onclick="addDeveloperPageEnt()">新增开发者</button>
</div>

<div style="width:100%;margin-top:10px;">
    <input name="userIdQuery" style="display: none"/>
    <input name="clinicIdQuery" style="display: none"/>
    <input name="hospitalIdQuery" style="display: none"/>
                <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
                    <span style="font-size: 14px">姓名:</span>
                    <span>
                        <span style="font-size: 10px"><input style="cursor: pointer"  id="realnameQueryFuzzyIf"  type="checkbox" value="1" /><label style="cursor: pointer"  for="realnameQueryFuzzyIf">模糊</label></span>
                        <input name="realnameQuery" style="width:170px"/>
                    </span>
                </div>
                <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
                    <span style="font-size: 14px">手机:</span>
                                <span>
                                    <span style="font-size: 10px"><input style="cursor: pointer"  id="phoneQueryFuzzyIf"  type="checkbox" value="1" /><label style="cursor: pointer"  for="phoneQueryFuzzyIf">模糊</label></span>
                                    <input name="phoneQuery" style="width:170px"/>
                                </span>
                </div>
                <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
                    <span style="font-size: 14px">医院:</span>
                    <span>
                        <span style="font-size: 10px"><input style="cursor: pointer"  id="hospitalNameQueryFuzzyIf"  type="checkbox" value="1" /><label style="cursor: pointer"  for="hospitalNameQueryFuzzyIf">模糊</label></span>
                        <input name="hospitalNameQuery" style="width:170px"/>
                    </span>
                </div>

                <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
                        <span style="font-size: 14px">类型:</span>
                        <span>
                            <select name="typeQuery" style="width:170px">
                                <option value="">全部</option>
                                <option value="1">医院</option>
                                <option value="2">门诊</option>
                                <option value="3">开发者</option>
                            </select>
                        </span>
                    </div>
    <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
        <span style="font-size: 14px">可登陆:</span>
                        <span>
                            <select name="ifLoginableQuery" style="width:170px">
                                <option value="">全部</option>
                                <option value="1">是</option>
                                <option value="0">否</option>
                            </select>
                        </span>
    </div>
    <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
        <span style="font-size: 14px">注册时间起:</span>
                    <span>
                        <input type="date" name="registerTimeStartQuery" />
                    </span>
    </div>
    <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
        <span style="font-size: 14px">注册时间止:</span>
                    <span>
                        <input type="date" name="registerTimeEndQuery" />
                    </span>
    </div>
    <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
        <span style="font-size: 14px">活跃时间起:</span>
                    <span>
                        <input type="date" name="lastAliveTimeStartQuery" />
                    </span>
    </div>
    <div style="float:left;margin:0 10px;;margin-top:5px;height:25px;">
        <span style="font-size: 14px">活跃时间止:</span>
                    <span>
                        <input type="date" name="lastAliveTimeEndQuery" />
                    </span>
    </div>
</div>

<div style="clear: both"></div>
<div id="itemsContainer" style="width:99%;border: 1px solid black;margin:0 auto;margin-top:10px;overflow: auto;" >
    <div name="itemsTable" style=";width:2000px">
        <div id="sum" style="border-bottom: 1px solid black;font-size: 15px;"></div>
        <div class="row-title">
        <span class="cell cell1">选择</span>
        <span class="cell cell2">手机</span>
        <span class="cell cell3">姓名</span>
        <span class="cell cell4">可登陆</span>
        <span class="cell cell5">类型</span>
            <span class="cell cell6">医院</span>
            <span class="cell cell7">门诊</span>
            <span class="cell cell8" style="cursor: pointer" onclick="sortItems('bonusPoint')">积分<span  id="bonusPointSort"  class="sortBtn"  >-</span></span>
            <span class="cell cell9" style="cursor: pointer" onclick="sortItems('registerTime')">注册时间<span  id="registerTimeSort"  class="sortBtn"  >-</span></span>
            <span class="cell cell10" style="cursor: pointer" onclick="sortItems('lastAliveTime')">活跃时间<span  id="lastAliveTimeSort"  class="sortBtn"  >-</span></span>
        <span class="cell cell11">操作</span>
    </div>
    <div name="itemExample" class="row row-item" style="display:none">
        <span class="cell cell1"><input type="radio" name="itemChosen" style="margin:0"></span>
        <span class="cell cell2" name="phone"></span>
        <span class="cell cell3" name="realname"></span>
        <span class="cell cell4" name="ifLoginable"></span>
        <span class="cell cell5" name="type"></span>
        <span class="cell cell6" name="hospitalName"></span>
        <span class="cell cell7" name="clinicName"></span>
        <span class="cell cell8" name="bonusPoint"></span>
        <span class="cell cell9" name="registerTime"></span>
        <span class="cell cell10" name="lastAliveTime"></span>
        <span class="cell cell11" ><button name="detailEnt">详情</button></span>
    </div>
    <div name="itemsShowPad" style="max-height:400px;overflow: auto;">
        <div name="itemsShow">

        </div>
        <div name="pagingBottomPad" style="text-align: center;margin:5px  0;">
            <span name="noitem" style="display:none;position: relative;z-index: 2;background:white;padding:0 5px;color:#7d7d7d">无数据</span>
            <span name="more" style="display:none;cursor:pointer;position: relative;z-index: 2;background:white;padding:0 5px;color:#7d7d7d" onclick="loadMore()">点击加载更多</span>
            <span name="finish" style="cursor: default;;display:none;position: relative;z-index: 2;background:white;padding:0 5px;color:#7d7d7d">加载完毕</span>
            <div style="margin:auto;position: relative; left: 0;top: -10px;width: 95%;height: 1px;background: #DCDCDC;z-index: 1;"></div>
        </div>
    </div>
</div>
</div>

<div id="addDeveloperPage" style="padding-top:100px;top:0;left:0;bottom:0;right:0;overflow:auto;z-index:999999999;display: none;position:fixed;background-color: rgba(0, 0, 0, 0.3)">
    <div style="width:30%;background-color: white;text-align:center;margin:auto;padding:15px 0;">
        <div >
            <div class="title">手机号</div>
            <div><input type="text" name="phone"></div>
        </div>
        <div style="margin-top:15px;">
            <div class="title">姓名</div>
            <div><input type="text" name="realname"></div>
        </div>
        <div style="margin:15px 0;">
            <div class="title">密码</div>
            <div><input name="pwd"  type="password" placeholder="最大长度32"/></div>
        </div>
        <div style="margin:15px 0;">
            <div class="title">确认密码</div>
            <div><input name="pwdConfirm"  type="password" placeholder="最大长度32"/></div>
        </div>
        <div style="margin-top: 15px">
            <button name="confirm" >确认</button><button name="cancel" style="margin-left:15px;">取消</button>
        </div>
    </div>
</div>

</body>

<script>
    var queryString,queryParams,token,page_no,page_size,items = {},hasMoreItems,sort,currentPath;
    sort={}
    token = $.cookie('login-token');
    queryString = giveup2.otherUtils.parseQueryStr(location.search.substr(1));
    queryParams = {token: token}
    currentPath=queryString.currentPath;
    $('#currentPath').text('当前路径: '+(currentPath?currentPath:''))
    $('[name=userIdQuery]').val(queryString.userIdQuery)
    $('[name=clinicIdQuery]').val(queryString.clinicIdQuery)
    $('[name=hospitalIdQuery]').val(queryString.hospitalIdQuery)
    $('[name=realnameQuery]').val(queryString.realnameQuery)
    if(queryString.realnameQueryFuzzyIf == 1)
        $('#realnameQueryFuzzyIf').attr("checked", true);
    $('[name=phoneQuery]').val(queryString.phoneQuery)
    if(queryString.phoneQueryFuzzyIf == 1)
        $('#phoneQueryFuzzyIf').attr("checked", true);
    $('[name=typeQuery]').val(queryString.typeQuery)
    $('[name=ifLoginable]').val(queryString.ifLoginableQuery)
    $('[name=hospitalNameQuery]').val(queryString.hospitalNameQuery)
    if(queryString.hospitalNameQueryFuzzyIf == 1)
        $('#hospitalNameQueryFuzzyIf').attr("checked", true);


    initPage();
    initQuery();
    loadItems();

    function initPage() {
        page_no = 1;
        page_size = 30;
        hasMoreItems = true;
        $('[name=itemsShow]').html('');
        $('[name=pagingBottomPad] [name=noitem]').css('display', '');
        $('[name=pagingBottomPad] [name=more]').css('display', 'none');
        $('[name=pagingBottomPad] [name=finish]').css('display', 'none');

    }

    function sortItems(sortColumn){
        if(sort[sortColumn]=='desc'){
            sort[sortColumn]='asc'
            $('#'+sortColumn+'Sort').text('↑')
        } else if(sort[sortColumn]=='asc'){
            delete sort[sortColumn]
            $('#'+sortColumn+'Sort').text('-')
        }else if(!sort[sortColumn]) {
            sort[sortColumn] = 'desc'
            $('#'+sortColumn+'Sort').text('↓')
        }
        else{
            sort[sortColumn]='desc'
            $('#'+sortColumn+'Sort').text('↓')
        }

        initPage();
        loadItems();
    }
    function query(){
        initPage();
        initQuery();
        loadItems();
    }
    function initQuery(){
        sort={};
        $('.sortBtn').text('-')
        queryParams.clinicId=$('[name=clinicIdQuery]').val().trim();
        queryParams.userId=$('[name=userIdQuery]').val().trim();
        queryParams.hospitalId=$('[name=hospitalIdQuery]').val().trim();
        queryParams.ifLoginable=$('[name=ifLoginableQuery]').val().trim();
        queryParams.realname=$('[name=realnameQuery]').val().trim();
        queryParams.realnameFuzzyIf=$('#realnameQueryFuzzyIf:checked').val();
        queryParams.phone=$('[name=phoneQuery]').val().trim();
        queryParams.phoneFuzzyIf=$('#phoneQueryFuzzyIf:checked').val();
        queryParams.type=$('[name=typeQuery]').val().trim();
        queryParams.hospitalName=$('[name=hospitalNameQuery]').val().trim();
        queryParams.hospitalNameFuzzyIf=$('#hospitalNameQueryFuzzyIf:checked').val();
        var registerTimeStart =   $('[name=registerTimeStartQuery]').val()
        if(registerTimeStart)
            queryParams.registerTimeStart=new Date(registerTimeStart).getTime();
        else
            queryParams.registerTimeStart = '';
        var registerTimeEnd = $('[name=registerTimeEndQuery]').val();
        if(registerTimeEnd)
            queryParams.registerTimeEnd=new Date(registerTimeEnd).getTime()+24*60*60*1000;
        else
            queryParams.registerTimeEnd = '';

        var lastAliveTimeStart =   $('[name=lastAliveTimeStartQuery]').val()
        if(lastAliveTimeStart)
            queryParams.lastAliveTimeStart=new Date(lastAliveTimeStart).getTime();
        else
            queryParams.lastAliveTimeStart = '';
        var lastAliveTimeEnd = $('[name=lastAliveTimeEndQuery]').val();
        if(lastAliveTimeEnd)
            queryParams.lastAliveTimeEnd=new Date(lastAliveTimeEnd).getTime()+24*60*60*1000;
        else
            queryParams.lastAliveTimeEnd = '';
    }
    function loadMore(){
        page_no++;
        loadItems();
    }

    giveup2.otherUtils.scrollEvent($('#itemsContainer').get(0), function () {
        if (hasMoreItems) {
            page_no++;
            loadItems();
        }
    })

    function loadItems(){
        queryParams.pn=page_no;
        queryParams.ps=page_size;
        queryParams.sort=''
        queryParams.order=''
        for(sortColumn in sort){
            queryParams.sort=queryParams.sort + sortColumn+','
            queryParams.order= queryParams.order+sort[sortColumn]+','
        }
        $.ajax({
            url: "/zaylt/mm/clientuser2/users" ,
            type: 'post',
            async: false,
            data: queryParams,
            success: function (res) {
                if (res.code == 0) {
                    var totalPageCount=res.data.totalCount%res.data.pageSize==0?res.data.totalCount/res.data.pageSize:parseInt(res.data.totalCount/res.data.pageSize)+1;
                    $('#sum').text('总计 '+res.data.totalCount+' 条记录,每页展示 '+res.data.pageSize+' 条，共 '+totalPageCount+' 页，当前第 '+page_no+' 页')
                    var itemsLength = res.data.items.length;
                    if(itemsLength==0 && page_no ==1){
                        hasMoreItems=false;
                    }else if(itemsLength>= 0 && itemsLength<page_size && page_no>=1){
                        $('[name=pagingBottomPad] [name=noitem]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=more]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=finish]').css('display', '');
                        hasMoreItems=false;
                    }else if(itemsLength==page_size){
                        $('[name=pagingBottomPad] [name=noitem]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=finish]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=more]').css('display', '');
                        hasMoreItems = true;
                    }
                    $(res.data.items).each(function(index,item){
                        items[item.userId]=item;
                        var newItemRow = $('[name=itemExample]').clone(true)
                        setItemRow(newItemRow,item)
                        newItemRow.css('display', '');
                        $('[name=itemsShow]').append(newItemRow)
                    })

                } else {
                    $.growl.error({ title:'', message: res.codeMsg });
                }
            }
        })
    }
    eventToRows()

    function setItemRow(itemRow,item) {
        itemRow.attr('name','')
        itemRow.attr('id','item'+item.userId)
        itemRow.find('[name=realname]').html(giveup2.otherUtils.strongKeyword(item.realname,queryParams.realname)).attr('title',item.realname)
        itemRow.find('[name=phone]').html(giveup2.otherUtils.strongKeyword(item.phone,queryParams.phone)).attr('title',item.phone)
        itemRow.find('[name=type]').html(parseUserType(item.type))
        itemRow.find('[name=hospitalName]').html(giveup2.otherUtils.strongKeyword(item.hospitalName,queryParams.hospitalName)).attr('title',item.hospitalName)
        itemRow.find('[name=clinicName]').html(giveup2.otherUtils.strongKeyword(item.clinicName,queryParams.clinicName)).attr('title',item.clinicName)
        itemRow.find('[name=registerTime]').text(giveup2.dateUtils.formatToDateTime(item.registerTime))
        itemRow.find('[name=lastAliveTime]').text(giveup2.dateUtils.formatToDateTime(item.lastAliveTime))
        itemRow.find('[name=bonusPoint]').text(item.bonusPoint)
        itemRow.find('[name=ifLoginable]').text(item.ifLoginable?'是':'否')
    }

    function eventToRows(){
        $('.row [name=detailEnt]').click(function(){
            var itemId = $(this).parents('.row').attr('id').substr(4);
           location.href="detail.html?itemId="+$(this).parents('.row').attr('id').substr(4)+'&currentPath='+currentPath+' / 用户详情 / '+items[itemId].realname
        })
        $('.row').click(function(){
            $('.row [name=itemChosen] ').prop("checked",false);
            $(this).find('[name=itemChosen]').prop("checked",true);
            $('.row').css('background-color','')
            $(this).css('background-color','#e8e8e8')
        })
    }



    function parseUserType(value){
        if(value==1)
            return '医院'
        else if(value == 2)
            return '门诊'
        else if(value == 3)
            return '开发者'
    }






function addDeveloperPageEnt(){
    $('#addDeveloperPage').trigger('pageOpen')
}


    $('#addDeveloperPage').bind('pageLoad',function(){
        var page = this;
        $(this).find('[name=cancel]').click(function(){
            $(this).trigger('pageClose')
        })

        $(this).find('[name=confirm]').click(function(){
            if(!$(page).find('[name=pwd]').val()){
                $.growl.error({ title:'', message: '密码不能空' });
                return;
            }
            if(!$(page).find('[name=pwdConfirm]').val()){
                $.growl.error({ title:'', message: '请输入确认密码' });
                return;
            }
            if($(page).find('[name=pwd]').val() != $(page).find('[name=pwdConfirm]').val()){
                $.growl.error({ title:'', message: '两次密码不一致' });
                return;
            }
            var param={}
            param.token=token;
            param.phone= $(page).find('[name=phone]').val()
            param.realname= $(page).find('[name=realname]').val()
            param.pwd= $(page).find('[name=pwd]').val()
            $.ajax({
                url: "/zaylt/mm/clientuser2/adddeveloper",
                type: 'post',
                async: false,
                data:param ,
                success: function (res) {
                    if (res.code == 0) {
                        $(page).trigger('pageClose')
                    } else {
                        $.growl.error({ title:'', message: res.codeMsg });
                    }
                }
            })
        })
    })

    $('#addDeveloperPage').bind('pageOpen',function(){
        $(this).find('[name=phone]').val('')
        $(this).find('[name=realname]').val('')
        $(this).find('[name=pwd]').val('')
        $(this).find('[name=pwdConfirm]').val('')
        $(this).show()
    })

    $('#addDeveloperPage').bind('pageClose',function(){
        $(this).hide()
    })

    $('#addDeveloperPage').trigger('pageLoad')

</script>

</html>