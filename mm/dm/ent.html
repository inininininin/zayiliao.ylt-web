<!DOCTYPE html>
<html>
<head>
    <title>器械管理</title>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <script src="../../libs/rxw/rxw.js"></script>
    <script src="../../libs/jquery.min.js"></script>
    <script src="../../libs/jquery.cookie.js"></script>


    <style>
        .cell {
            text-align: center;
            display: inline-block;
            padding:0 5px;
            overflow: hidden;
            height:100%;
            white-space:nowrap;
            text-overflow:ellipsis;
            cursor: default;
        }
        .cell1 {
            width:60px;
        }
        .cell2 {
            width:200px;
            border-left: 1px solid #7d7d7d;
        }
        .cell3 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell4 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell5 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell6 {
            width:100px;
            border-left: 1px solid #7d7d7d;
        }
        .cell7 {
            width:60px;
            border-left: 1px solid #7d7d7d;
        }
        .row {
            border-top: 1px solid #7d7d7d;
            padding:3px 0;
            height:20px;
            font-size:15px;
            min-width:1000px;
        }

        .row:hover{
            background-color:#e8e8e8;
        }
        .row-title {
            padding:2px 0;
            min-width:1000px;
            background-color:#e8e8e8;
        }

    </style>
</head>

<body style="margin:0;">
<div id="localPath"  style="margin:5px 0 0 5px;font-size: 14px"></div>
<hr/>
<div style="width:100%;margin-top:5px;">
    <button style="margin:0 5px;display:inline-block;margin-top:5px;min-width:60px;padding:0 10px;height:25px" onclick="query()">查询</button>
    <button style="margin:0 5px;display:inline-block;margin-top:5px;min-width:60px;padding:0 10px;height:25px" onclick="addDevice()">新增器械</button>
</div>

<div style="width:100%;margin-top:10px;">
                <span style="margin:0 5px;display:inline-block;margin-top:5px;width:20%">
                    <span style="font-size: 14px">器械名:</span>
                    <span style="float:right">
                        <input name="nameQuery" style="width:170px"/>
                    </span>
                </span>
                <span style="margin:0 5px;display:inline-block;margin-top:5px;width:20%">
                    <span style="font-size: 14px">联系电话:</span>
                    <span style="float:right">
                        <input name="contactTelQuery" style="width:170px"/>
                    </span>
                </span>
</div>

<div id="itemsContainer" style="width:99%;border: 1px solid black;margin:0 auto;margin-top:10px;overflow: auto;" >
    <div class="row-title">
        <span class="cell cell1">选择</span>
        <span class="cell cell2">器械名</span>
        <span class="cell cell3">封面</span>
        <span class="cell cell7"  style="cursor: pointer" onclick="sortItems('stock')">库存<span id="stockSort" class="sortBtn" >-</span></span>
        <span class="cell cell4">联系电话</span>
        <span class="cell cell5" style="cursor: pointer" onclick="sortItems('sortNo')">排序<span  id="sortNoSort"  class="sortBtn"  >-</span></span>
        <span class="cell cell6">操作</span>
    </div>
    <div name="itemExample" class="row" style="display:none">
        <span class="cell cell1"><input type="radio" name="itemChosen" style="margin:0"></span>
        <span class="cell cell2" name="name"></span>
        <span class="cell cell3" ><img name="cover" style="width:30px;vertical-align: middle"/></span>
        <span class="cell cell7" name="stock"></span>
        <span class="cell cell4" name="contactTel"></span>
        <span class="cell cell5" name="sortNo"></span>
        <span class="cell cell6" ><button name="deviceEntDoor">详情</button><button name="delEntDoor">删除</button></span>
    </div>
    <div name="itemsShowPad" style="max-height:400px;">
        <div name="itemsShow">

        </div>
        <div name="pagingBottomPad" style="text-align: center;margin:5px  0;">
            <span name="noitem" style="display:none;position: relative;z-index: 2;background:white;padding:0 5px;color:#7d7d7d">无数据</span>
            <span name="more" style="display:none;cursor:pointer;position: relative;z-index: 2;background:white;padding:0 5px;color:#7d7d7d" onclick="loadMore()">点击加载更多</span>
            <span name="finish" style="cursor: default;;display:none;position: relative;z-index: 2;background:white;padding:0 5px;color:#7d7d7d">加载完毕</span>
            <div style="margin:auto;position: relative; left: 0;top: -10px;width: 95%;height: 1px;background: #DCDCDC;z-index: 1;"></div>
        </div>
    </div>

</div>

</body>
<script>
    rxw1.relativePath = '../../libs/'
    var queryString,queryParams,token,page_no,page_size,items = {},hasMoreItems,sort,localPath;
    sort={}
    token = $.cookie('login-token');
    queryString = rxw1.parseQueryStr(location.search.substr(1));
    queryParams = {token: token}
    localPath=queryString.localPath;
    $('#localPath').text('当前路径: '+localPath)
    initData();
    function initData() {
        rxw1.waitLock()
        page_no = 1;
        page_size = 30;
        hasMoreItems = true;
        $('[name=itemsShow]').html('');
        $('[name=pagingBottomPad] [name=noitem]').css('display', '');
        $('[name=pagingBottomPad] [name=more]').css('display', 'none');
        $('[name=pagingBottomPad] [name=finish]').css('display', 'none');
        loadItems();
        rxw1.waitLock.remove()
    }

    function sortItems(sortColumn){
        if(sort[sortColumn]=='desc'){
            sort[sortColumn]='asc'
            $('#'+sortColumn+'Sort').text('↑')
        } else if(sort[sortColumn]=='asc'){
            delete sort[sortColumn]
            $('#'+sortColumn+'Sort').text('-')
        }else if(!sort[sortColumn]) {
            sort[sortColumn] = 'desc'
            $('#'+sortColumn+'Sort').text('↓')
        }
        else{
            sort[sortColumn]='desc'
            $('#'+sortColumn+'Sort').text('↓')
        }

        initData();
    }
    function query(){
        sort={};
        $('.sortBtn').text('-')
        queryParams.name=$('[name=nameQuery]').val().trim();
        queryParams.contactTel=$('[name=contactTelQuery]').val().trim();
        initData();
    }
    function loadMore(){
        rxw1.waitLock()
        page_no++;
        loadItems();
        rxw1.waitLock.remove()
    }
    rxw1.scrollEvent($('#itemsContainer').get(0), function () {
        if (hasMoreItems) {
            page_no++;
            loadItems();
        }
    })
    function loadItems(){
        queryParams.pn=page_no;
        queryParams.ps=page_size;
        queryParams.sort=''
        queryParams.order=''
        for(sortColumn in sort){
            queryParams.sort=queryParams.sort + sortColumn+','
            queryParams.order= queryParams.order+sort[sortColumn]+','
        }
        $.ajax({
            url: "/zaylt/mm/devicemg/devicelist" ,
            type: 'post',
            async: false,
            data: queryParams,
            success: function (res) {
                if (res.code == 0) {
                    var itemsLength = res.data.items.length;
                    if(itemsLength==0 && page_no ==1){
                        hasMoreItems=false;
                    }else if(itemsLength>= 0 && itemsLength<page_size && page_no>=1){
                        $('[name=pagingBottomPad] [name=noitem]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=more]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=finish]').css('display', '');
                        hasMoreItems=false;
                    }else if(itemsLength==page_size){
                        $('[name=pagingBottomPad] [name=noitem]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=finish]').css('display', 'none');
                        $('[name=pagingBottomPad] [name=more]').css('display', '');
                        hasMoreItems = true;
                    }
                    $(res.data.items).each(function(index,item){
                        items[item.deviceId]=item;
                        var newItemRow = $('[name=itemExample]').clone(true)
                        setItemRow(newItemRow,item)
                        newItemRow.css('display', '');
                        $('[name=itemsShow]').append(newItemRow)
                    })

                } else {
                    rxw1.errorpad(res.codeMsg)
                }
            }
        })
    }
    eventToRows()

    function refreshItemRow(itemRow,itemId){
        $.ajax({
            url: "/zaylt/mm/devicemg/deviceinfo",
            type: 'post',
            async: false,
            data: {deviceId:itemId,token:token},
            success: function (res) {
                if(res.code==0){
                    var item = res.data;
                    items[itemId]= item;
                    setItemRow(itemRow,item)
                }else{
                    rxw1.errorpad(res.codeMsg)
                }
            }
        })
    }


    function strongKeyword(){
        if(arguments.length==0)
            return '';
        var srcText=arguments[0];
        if(arguments.length==1)
            return srcText;
        for(var a in arguments){
            if(a>0){
                var keyword = arguments[a];
                if(!keyword)
                    continue;
                var index = srcText.indexOf(keyword);
                if(index<0)
                    continue;
                var aaa = srcText.substr(index,keyword.length);
                var bbb = '<span style="color:red">'+aaa+'</span>'
                srcText = srcText.replace(aaa,bbb)
            }
        }
        return srcText;
    }

    function setItemRow(itemRow,item) {
        itemRow.attr('name','')
        itemRow.attr('id','item'+item.deviceId)
        itemRow.find('[name=name]').html(strongKeyword(item.name,queryParams.name)).attr('title',item.name)
        itemRow.find('[name=contactTel]').html(strongKeyword(item.contactTel,queryParams.contactTel)).attr('title',item.contactTel)
        itemRow.find('[name=sortNo]').text(item.sortNo)
        itemRow.find('[name=cover]').attr('src',item.cover)
        itemRow.find('[name=stock]').text(item.stock)
    }

    function eventToRows(){
        $('.row [name=delEntDoor]').click(function(){
            var row = $(this).parents('.row');
            var itemId = row.attr('id').substr(4)
            if (confirm('确认删除吗')==true){
                $.ajax({
                    url: "/zaylt/mm/devicemg/devicedel",
                    type: 'post',
                    async: false,
                    data: {deviceId:itemId,token:token},
                    success: function (res) {
                        if(res.code==0){
                            row.remove()
                        }else{
                            rxw1.errorpad(res.codeMsg)
                        }
                    }
                })
                return true;
            }else{
                return false;
            }
        })
        $('.row [name=deviceEntDoor]').click(function(){
           location.href="detail.html?deviceId="+$(this).parents('.row').attr('id').substr(4)+'&localPath='+localPath+' / 器械详情'
        })
        $('.row [name=cover]').click(function(){
            rxw1.imgPreview(this.src)
        }).css('cursor','pointer')
        $('.row').click(function(){
            $('.row [name=itemChosen] ').prop("checked",false);
            $(this).find('[name=itemChosen]').prop("checked",true);
            $('.row').css('background-color','')
            $(this).css('background-color','#e8e8e8')
        })
    }

function addDevice(){
   location.href='add.html?localPath='+localPath+' / 新增器械'
}


</script>

</html>